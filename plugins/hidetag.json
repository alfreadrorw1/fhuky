module.exports = {
    name: "Hidetag",
    command: ["h", "ht", "hidetag"], // Command yang bisa dipakai
    execute: async (sock, m, { args, isOwner }) => {
        const jid = m.key.remoteJid
        
        // 1. Cek apakah ini Grup
        if (!jid.endsWith("@g.us")) {
            return sock.sendMessage(jid, { text: "❌ Fitur ini hanya untuk grup!" }, { quoted: m })
        }

        try {
            // Ambil data metadata grup untuk dapetin list member
            const groupMetadata = await sock.groupMetadata(jid)
            const participants = groupMetadata.participants
            const mentions = participants.map(p => p.id) // Ambil semua ID member

            // 2. Cek apakah Pengirim adalah Admin
            const sender = m.key.participant || m.key.remoteJid
            const participant = participants.find(p => p.id === sender)
            const isAdmin = participant?.admin === 'admin' || participant?.admin === 'superadmin'

            // Logic: Jika bukan Admin DAN bukan Owner, tolak.
            if (!isAdmin && !isOwner) {
                return sock.sendMessage(jid, { text: "❌ Lu siapa? Fitur ini khusus Admin!" }, { quoted: m })
            }

            // 3. Siapkan Pesan
            let text = args.join(" ")
            let quoted = m.quoted ? m.quoted : m
            
            // Cek apakah user mereply pesan orang lain (Untuk mengambil konteks reply)
            // Di Baileys Raw, struktur quoted ada di m.message.extendedTextMessage.contextInfo
            const isQuotedMsg = m.message?.extendedTextMessage?.contextInfo?.quotedMessage

            if (isQuotedMsg) {
                // Jika user mereply pesan: Kita ambil tipe pesannya dan copy
                // Karena forwarding raw baileys agak ribet, opsi teraman adalah Hidetag Text biasa
                // Tapi kita kasih opsi Text Default jika user cuma ketik .h tanpa teks
                if (!text) text = "Attention All Members!"
            } else {
                // Jika tidak mereply, dan tidak ada teks, kasih default
                if (!text) text = "Attention All Members!"
            }

            // 4. Kirim Hidetag
            // Kita kirim pesan teks biasa tapi menyisipkan 'mentions' ke semua orang
            await sock.sendMessage(jid, {
                text: text,
                mentions: mentions
            })

        } catch (e) {
            console.error("Hidetag Error:", e)
            await sock.sendMessage(jid, { text: "❌ Gagal memuat data grup." }, { quoted: m })
        }
    }
}
